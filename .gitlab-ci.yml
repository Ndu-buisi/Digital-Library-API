
variables:
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  SAST_EXCLUDED_ANALYZERS: "brakeman,flawfinder,phpcs-security-audit,pmd-apex,sobelow,spotbugs"

stages:
  - build
  - test
  - deploy

build:
  stage: build
  image: node:18-alpine
  script:
    - echo "=== PREPARING FILES FOR SECURITY SCANNING ==="
    - echo "Installing dependencies to generate package-lock.json..."
    - npm install --package-lock-only
    - echo "Files available for dependency scanning:"
    - ls -la package*.json
    - echo "Package.json content verification:"
    - head -10 package.json
    - echo "Dependencies that should be detected by scanner:"
    - grep -A 20 '"dependencies"' package.json
  artifacts:
    paths:
      - package.json          # ‚Üê ESSENTIAL for dependency scanning
      - package-lock.json     # ‚Üê ESSENTIAL for dependency scanning  
      - node_modules/         # ‚Üê Helpful for analysis
      - src/                  # ‚Üê For SAST scanning
      - config/               # ‚Üê For secret detection
      - .env                  # ‚Üê For secret detection
      - "*.js"                # ‚Üê For SAST scanning
      - "*.json"              # ‚Üê For configuration scanning
    expire_in: 2 hours        # ‚Üê Long enough for security scans
    when: always              # ‚Üê Create artifacts even if build fails
  cache:
    paths:
      - node_modules/



test:unit:
  stage: test
  image: node:18-alpine
  script:
    - echo "Running unit tests"
    - npm run test:unit || echo "Tests would run here"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'

test:pr-only:
  stage: test
  image: node:18-alpine
  script:
    - echo "This job only runs on GitHub Pull Requests"
    - echo "PR-specific tests would run here"
  rules:
    - if: $CI_PIPELINE_SOURCE == "external_pull_request_event"



deploy_dev:
  stage: deploy
  image: alpine:latest
  script:
    - echo "üöÄ Deploying to development environment..."
    - echo "üì° Application deployed successfully"
  environment:
    name: development
    url: https://dev-api.example.com
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
  dependencies:
    - build
    - test:pr-only
