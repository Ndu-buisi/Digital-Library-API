
variables:
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  SAST_EXCLUDED_ANALYZERS: "brakeman,flawfinder,phpcs-security-audit,pmd-apex,sobelow,spotbugs"

stages:
  - build
  - test
  - deploy

build:
  stage: build
  image: node:18-alpine
  script:
    - echo "=== PREPARING FILES FOR SECURITY SCANNING ==="
    - echo "Generating fresh package-lock.json from package.json..."
    - npm install --package-lock-only --no-audit
    - echo ""
    - echo "✅ Files created for dependency scanning:"
    - ls -la package*.json
    - echo ""
    - echo "📦 Package-lock.json verification:"
    - head -10 package-lock.json
    - echo ""
    - echo "🔍 Vulnerable dependencies that should be detected:"
    - echo "- lodash 4.17.15 (Prototype Pollution)"
    - echo "- axios 0.19.2 (Server-side Request Forgery)"
    - echo "- moment 2.24.0 (Regular Expression DoS)"
    - echo "- handlebars 4.0.0 (Template Injection)"
  artifacts:
    paths:
      - package.json          # ← Original package.json
      - package-lock.json     # ← Freshly generated lockfile
      - src/                  # ← For SAST scanning
      - .env                  # ← For secret detection
      - config/               # ← For secret detection
    expire_in: 2 hours
    when: always
  cache:
    paths:
      - .npm/

debug_files:
  stage: test
  image: alpine:latest
  script:
    - echo "=== DEPENDENCY SCANNING FILE VERIFICATION ==="
    - echo "📁 Available files:"
    - ls -la
    - echo ""
    - echo "📦 Package.json exists: $(test -f package.json && echo '✅ YES' || echo '❌ NO')"
    - echo "🔒 Package-lock.json exists: $(test -f package-lock.json && echo '✅ YES' || echo '❌ NO')"
    - echo ""
    - if [ -f package.json ]; then
        echo "🔍 Dependencies in package.json:"
        grep -A 15 '"dependencies"' package.json | grep -E '(lodash|axios|moment|handlebars|tar|minimist|jsonwebtoken)'
      fi
    - echo ""
    - if [ -f package-lock.json ]; then
        echo "🔒 Package-lock.json structure:"
        echo "- Lockfile version: $(grep -o '"lockfileVersion":[0-9]*' package-lock.json)"
        echo "- Dependencies count: $(grep -c '"version":' package-lock.json || echo '0')"
      fi
  dependencies:
    - build
  allow_failure: true

test:unit:
  stage: test
  image: node:18-alpine
  script:
    - echo "Running unit tests"
    - npm run test:unit || echo "Tests would run here"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'

test:pr-only:
  stage: test
  image: node:18-alpine
  script:
    - echo "This job only runs on GitHub Pull Requests"
    - echo "PR-specific tests would run here"
  rules:
    - if: $CI_PIPELINE_SOURCE == "external_pull_request_event"



deploy_dev:
  stage: deploy
  image: alpine:latest
  script:
    - echo "🚀 Deploying to development environment..."
    - echo "📡 Application deployed successfully"
  environment:
    name: development
    url: https://dev-api.example.com
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
  dependencies:
    - build
    - test:pr-only
